FROM public.ecr.aws/lambda/python:3.12

WORKDIR ${LAMBDA_TASK_ROOT}

ARG DB_PROD_URL
ARG DB_DEV_NAME
ARG DB_DEV_URL

ARG OPENAI_API_KEY
ARG ANTHROPIC_API_KEY
ARG GETIMG_API_KEY

ARG JWT_SECRET_KEY
ARG JWT_ACCESS_TOKEN_EXPIRE_SECONDS
ARG JWT_REFRESH_TOKEN_EXPIRE_SECONDS
ARG JWT_ALGORITHM

ARG GOOGLE_CLIENT_ID
ARG GOOGLE_SECRET_KEY
ARG GOOGLE_DEV_REDIRECT_URL
ARG GOOGLE_PROD_REDIRECT_URL
ARG GOOGLE_SCOPE_PROFILE
ARG GOOGLE_SCOPE_EMAIL

ARG NAVER_CLIENT_ID
ARG NAVER_SECRET_KEY
ARG NAVER_DEV_REDIRECT_URL
ARG NAVER_PROD_REDIRECT_URL

ARG KAKAO_CLIENT_ID
ARG KAKAO_SECRET_KEY
ARG KAKAO_DEV_REDIRECT_URL
ARG KAKAO_PROD_REDIRECT_URL

ARG DAILY_DEV_REVISION_LIMIT
ARG DAILY_PROD_REVISION_LIMIT

ARG AWS_BOOK_COVER_BUCKET_NAME
ARG AWS_PAGE_IMAGE_BUCKET_NAME

ENV DB_PROD_URL="${DB_PROD_URL:-}" \
    DB_DEV_NAME="${DB_DEV_NAME:-}" \
    DB_DEV_URL="${DB_DEV_URL:-}" \
    OPENAI_API_KEY="${OPENAI_API_KEY:-}" \
    GETIMG_API_KEY="${GETIMG_API_KEY:-}" \
    ANTHROPIC_API_KEY="${ANTHROPIC_API_KEY:-}" \
    JWT_SECRET_KEY="${JWT_SECRET_KEY:-}" \
    JWT_ACCESS_TOKEN_EXPIRE_SECONDS="${JWT_ACCESS_TOKEN_EXPIRE_SECONDS:-}" \
    JWT_REFRESH_TOKEN_EXPIRE_SECONDS="${JWT_REFRESH_TOKEN_EXPIRE_SECONDS:-}" \
    JWT_ALGORITHM="${JWT_ALGORITHM:-}" \
    GOOGLE_CLIENT_ID="${GOOGLE_CLIENT_ID:-}" \
    GOOGLE_SECRET_KEY="${GOOGLE_SECRET_KEY:-}" \
    GOOGLE_DEV_REDIRECT_URL="${GOOGLE_DEV_REDIRECT_URL:-}" \
    GOOGLE_PROD_REDIRECT_URL="${GOOGLE_PROD_REDIRECT_URL:-}" \
    GOOGLE_SCOPE_PROFILE="${GOOGLE_SCOPE_PROFILE:-}" \
    GOOGLE_SCOPE_EMAIL="${GOOGLE_SCOPE_EMAIL:-}" \
    NAVER_CLIENT_ID="${NAVER_CLIENT_ID:-}" \
    NAVER_SECRET_KEY="${NAVER_SECRET_KEY:-}" \
    NAVER_DEV_REDIRECT_URL="${NAVER_DEV_REDIRECT_URL:-}" \
    NAVER_PROD_REDIRECT_URL="${NAVER_PROD_REDIRECT_URL:-}" \
    KAKAO_CLIENT_ID="${KAKAO_CLIENT_ID:-}" \
    KAKAO_SECRET_KEY="${KAKAO_SECRET_KEY:-}" \
    KAKAO_DEV_REDIRECT_URL="${KAKAO_DEV_REDIRECT_URL:-}" \
    KAKAO_PROD_REDIRECT_URL="${KAKAO_PROD_REDIRECT_URL:-}" \
    DAILY_DEV_REVISION_LIMIT="${DAILY_DEV_REVISION_LIMIT:-}" \
    DAILY_PROD_REVISION_LIMIT="${DAILY_PROD_REVISION_LIMIT:-}" \
    DAILY_PROD_PREMIUM_REVISION_LIMIT="${DAILY_PROD_PREMIUM_REVISION_LIMIT:-}" \
    AWS_BOOK_COVER_BUCKET_NAME="${AWS_BOOK_COVER_BUCKET_NAME:-}" \
    AWS_PAGE_IMAGE_BUCKET_NAME="${AWS_PAGE_IMAGE_BUCKET_NAME:-}" \
    ENVIRONMENT="prod" \
    PYTHONPATH="${LAMBDA_TASK_ROOT}/src"

COPY ./requirements.txt ${LAMBDA_TASK_ROOT}/requirements.txt

RUN pip install --no-cache-dir --upgrade -r ${LAMBDA_TASK_ROOT}/requirements.txt

COPY ./src ${LAMBDA_TASK_ROOT}/src

ENTRYPOINT [ "python3", "-m", "awslambdaric" ]
CMD ["src.main.handler"]